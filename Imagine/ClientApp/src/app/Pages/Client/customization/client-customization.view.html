<section class="client-customization">
  <div class="cz-background">
    <div class="cz-orb orb-left"></div>
    <div class="cz-orb orb-right"></div>
    <div class="cz-grid"></div>
  </div>

  <div class="container position-relative">
    <div class="cz-inner">
      <div class="cz-neural-overlay" aria-hidden="true">
        <svg class="cz-neural-svg" viewBox="0 0 1200 400" preserveAspectRatio="xMidYMid slice">
          <defs>
            <linearGradient id="czLineGradient1" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#4A90E2;stop-opacity:0" />
              <stop offset="35%" style="stop-color:#00D9FF;stop-opacity:0.9" />
              <stop offset="70%" style="stop-color:#8B5CF6;stop-opacity:0.8" />
              <stop offset="100%" style="stop-color:#FF6EC7;stop-opacity:0" />
            </linearGradient>
          </defs>

          <path
            class="cz-neural-line l1"
            d="M 0 80 Q 220 40 440 80 T 880 80 T 1200 80"
            stroke="url(#czLineGradient1)"
          />
          <path
            class="cz-neural-line l2"
            d="M 0 200 Q 260 260 520 200 T 1040 200 T 1200 200"
            stroke="url(#czLineGradient1)"
          />
          <path
            class="cz-neural-line l3"
            d="M 0 320 Q 260 280 520 320 T 1040 320 T 1200 320"
            stroke="url(#czLineGradient1)"
          />

          <circle class="cz-neural-node n1" cx="140" cy="80" r="3" />
          <circle class="cz-neural-node n2" cx="360" cy="70" r="4" />
          <circle class="cz-neural-node n3" cx="640" cy="90" r="3" />
          <circle class="cz-neural-node n4" cx="900" cy="70" r="4" />
          <circle class="cz-neural-node n5" cx="220" cy="200" r="3" />
          <circle class="cz-neural-node n6" cx="520" cy="210" r="4" />
          <circle class="cz-neural-node n7" cx="820" cy="190" r="3" />
          <circle class="cz-neural-node n8" cx="320" cy="320" r="4" />
          <circle class="cz-neural-node n9" cx="720" cy="330" r="3" />
        </svg>
      </div>
      <header class="cz-header">
        <div class="cz-header-text">
          <p class="cz-eyebrow">AI customization studio</p>
          <h1 class="cz-title">Create your custom AI-generated print</h1>
          <p class="cz-subtitle">
            Describe your dream artwork and preview it on premium hoodies and T-shirts.
          </p>
        </div>
      </header>

      <div class="row g-4 cz-layout">
        <!-- Left column: prompt + selector -->
        <div class="col-lg-7">
          <div class="cz-card cz-prompt-card">
            <div class="cz-prompt-particles">
              <span class="cz-particle-dot d1"></span>
              <span class="cz-particle-dot d2"></span>
              <span class="cz-particle-dot d3"></span>
              <span class="cz-particle-dot d4"></span>
              <span class="cz-particle-dot d5"></span>
              <span class="cz-particle-dot d6"></span>
            </div>
            <div class="cz-card-header">
              <h2>Step 1 &middot; Describe your vision</h2>
              <p>Write a short prompt for the AI to imagine your perfect print.</p>
            </div>

            <div class="cz-prompt-body">
              <label class="cz-label" for="promptTextarea">AI prompt</label>
              <textarea
                id="promptTextarea"
                [(ngModel)]="prompt"
                rows="6"
                class="cz-prompt-textarea"
                placeholder="e.g. Neon cyberpunk city at night, soft purple and blue glow, minimal line art, centered composition"
              ></textarea>
              <p class="cz-helper-text">
                The more specific you are, the more unique your design will feel. Mention style,
                colors, mood, and layout.
              </p>

              <div class="cz-actions">
                <button
                  type="button"
                  class="btn btn-primary-custom cz-generate-btn"
                  [disabled]="!prompt || isGenerating"
                  (click)="onGenerate()"
                >
                  <ng-container *ngIf="!isGenerating">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span>Generate preview</span>
                  </ng-container>
                  <ng-container *ngIf="isGenerating">
                    <span class="cz-button-spinner"></span>
                    <span>Imagining your design...</span>
                  </ng-container>
                </button>

                <button
                  type="button"
                  class="btn cz-clear-btn"
                  [disabled]="isGenerating && !hasPreview && !prompt"
                  (click)="onClear()"
                >
                  <i class="fas fa-rotate"></i>
                  <span>Clear</span>
                </button>
              </div>

              <div class="cz-loading-hint" *ngIf="isGenerating">
                <div class="cz-loading-bar">
                  <div class="cz-loading-fill"></div>
                </div>
                <p>Our models are sketching your concept in real time.</p>
              </div>
            </div>
          </div>

          <!-- Generated design preview on selected base garment -->
          <div class="cz-card cz-preview-card mt-3" [class.has-preview]="preprocessedGarmentUrl">
            <div class="cz-card-header cz-preview-header">
              <div>
                <h2>Step 3 &middot; Preview your AI design</h2>
                <p>See your prompt applied to the {{ selectedLabel.toLowerCase() }} before ordering.</p>
              </div>
            </div>

            <div class="cz-preview-body">
              <div class="cz-mannequin" [class.has-preview]="preprocessedGarmentUrl">
                <div class="cz-garment-outline"></div>
                <div class="cz-print-area" [class.has-preview]="preprocessedGarmentUrl">
                  <div class="cz-print-skeleton" *ngIf="!preprocessedGarmentUrl && !isGenerating">
                    <span>Your generated design will appear here after you click "Generate preview".</span>
                  </div>

                  <div class="cz-print-loading" *ngIf="isGenerating">
                    <div class="cz-shimmer"></div>
                  </div>

                  <div class="cz-print-mock" *ngIf="preprocessedGarmentUrl && !isGenerating">
                    <p class="cz-print-label">AI-generated mockup</p>
                    <img
                      [src]="preprocessedGarmentUrl"
                      alt="AI generated garment"
                      class="img-fluid rounded-3"
                      style="max-height: 100%; object-fit: cover;"
                    />
                  </div>
                </div>
              </div>
              <p class="cz-preview-note">
                This image is generated from your prompt and the selected base garment. You can adjust the
                prompt or upload your own garment image on the right, then generate again.
              </p>
            </div>
          </div>

          <div class="cz-card cz-selector-card mt-3">
            <div class="cz-card-header">
              <h2>Step 2 &middot; Choose your base</h2>
              <p>Select whether you want this print on a hoodie or a T-shirt.</p>
            </div>

            <div class="cz-type-toggle">
              <button
                type="button"
                class="cz-type-pill"
                [class.selected]="selectedType === 'hoodie'"
                (click)="onSelectType('hoodie')"
              >
                <div class="pill-icon"><i class="fas fa-user-astronaut"></i></div>
                <div class="pill-text">
                  <div class="pill-title">Hoodie</div>
                  <div class="pill-subtitle">Cozy, heavyweight, perfect for bold AI art.</div>
                </div>
              </button>

              <button
                type="button"
                class="cz-type-pill"
                [class.selected]="selectedType === 'tshirt'"
                (click)="onSelectType('tshirt')"
              >
                <div class="pill-icon"><i class="fas fa-tshirt"></i></div>
                <div class="pill-text">
                  <div class="pill-title">T-shirt</div>
                  <div class="pill-subtitle">Lightweight and everyday-ready, with crisp prints.</div>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Right column: try-on preview + controls -->
        <div class="col-lg-5">
          <div class="cz-card cz-preview-card" [class.has-preview]="tryOnStatus === 'completed' && tryOnImageUrl">
            <div class="cz-card-header cz-preview-header">
              <div>
                <h2>Virtual try-on preview</h2>
                <p>Upload your photo and a garment to see a realistic AI try-on.</p>
              </div>
              <span class="cz-tag">Beta &middot; AI powered</span>
            </div>

            <div class="cz-preview-body">
              <div class="mb-3">
                <label class="cz-label">1. Garment image</label>
                <input
                  type="file"
                  class="form-control form-control-sm bg-dark text-light"
                  accept="image/*"
                  (change)="onGarmentFileChange($event)"
                />
                <small class="text-muted d-block mt-1">
                  JPG / PNG / WEBP, max 8MB. Ideally a clear product photo.
                </small>
                <div class="mt-2" *ngIf="garmentPreviewUrl">
                  <img
                    [src]="garmentPreviewUrl"
                    alt="Garment preview"
                    class="img-fluid rounded-3 border border-secondary-subtle"
                  />
                </div>
              </div>

              <div class="mb-3">
                <label class="cz-label">2. Your photo</label>
                <input
                  type="file"
                  class="form-control form-control-sm bg-dark text-light"
                  accept="image/*"
                  (change)="onPersonFileChange($event)"
                />
                <small class="text-muted d-block mt-1">
                  Clear front-facing photo, good lighting, minimal background clutter.
                </small>
                <div class="mt-2" *ngIf="personPreviewUrl">
                  <img
                    [src]="personPreviewUrl"
                    alt="Person preview"
                    class="img-fluid rounded-3 border border-secondary-subtle"
                  />
                </div>
              </div>

              <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                <button
                  type="button"
                  class="btn btn-outline-info btn-sm"
                  [disabled]="isPreprocessing || isStartingTryOn || isPolling"
                  (click)="onPreprocessGarment()"
                >
                  <span *ngIf="!isPreprocessing">Optional: Clean garment (preprocess)</span>
                  <span *ngIf="isPreprocessing">
                    <span class="cz-button-spinner"></span>
                    Preprocessing garment...
                  </span>
                </button>

                <button
                  type="button"
                  class="btn btn-primary-custom btn-sm"
                  [disabled]="!isTryOnReady || isStartingTryOn || isPolling"
                  (click)="onStartTryOn()"
                >
                  <ng-container *ngIf="!isStartingTryOn && !isPolling">
                    <i class="fas fa-user-astronaut"></i>
                    <span>Start try-on</span>
                  </ng-container>
                  <ng-container *ngIf="isStartingTryOn || isPolling">
                    <span class="cz-button-spinner"></span>
                    <span>Generating your try-on...</span>
                  </ng-container>
                </button>

                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  [disabled]="!isPolling"
                  (click)="onCancelTryOn()"
                >
                  Cancel
                </button>
              </div>

              <div class="small text-muted mb-2">
                Status: <strong>{{ displayStatusLabel }}</strong>
                <ng-container *ngIf="tryOnStatus === 'processing' || tryOnStatus === 'queued'">
                  &mdash; Typically completes in 10&ndash;30 seconds.
                </ng-container>
              </div>

              <div *ngIf="tryOnError" class="alert alert-danger py-1 px-2 small mb-2">
                {{ tryOnError }}
              </div>

              <div class="cz-mannequin" [class.has-preview]="tryOnStatus === 'completed' && tryOnImageUrl">
                <div class="cz-garment-outline"></div>
                <div class="cz-print-area" [class.has-preview]="tryOnStatus === 'completed' && tryOnImageUrl">
                  <div
                    class="cz-print-skeleton"
                    *ngIf="!tryOnImageUrl && !(isStartingTryOn || isPolling) && !tryOnError"
                  >
                    <span>Try-on result will appear here once generated.</span>
                  </div>

                  <div class="cz-print-loading" *ngIf="isStartingTryOn || isPolling">
                    <div class="cz-shimmer"></div>
                  </div>

                  <div class="cz-print-mock" *ngIf="tryOnStatus === 'completed' && tryOnImageUrl">
                    <p class="cz-print-label">AI try-on result</p>
                    <img
                      [src]="tryOnImageUrl"
                      alt="Try-on result"
                      class="img-fluid rounded-3"
                      style="max-height: 100%; object-fit: cover;"
                    />
                  </div>
                </div>
              </div>

              <div class="cz-preview-orbits" aria-hidden="true">
                <div class="cz-orbit-icon oi-1 glass-effect">
                  <i class="fas fa-sparkles"></i>
                </div>
                <div class="cz-orbit-icon oi-2 glass-effect">
                  <i class="fas fa-microchip"></i>
                </div>
              </div>

              <p class="cz-preview-note">
                This is a beta virtual try-on powered by external AI. Images are processed securely and
                only used to generate your preview.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
